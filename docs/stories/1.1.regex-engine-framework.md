# Story 1.1: 正则引擎框架搭建

**Epic:** Epic 1 - 核心确定性引擎（正则表达式引擎）
**Story ID:** 1.1
**优先级:** P0
**工作量:** 3 天

---

## Status
**Draft**

---

## Story

**As a** 开发者，
**I want** 一个可扩展的正则表达式引擎框架，
**so that** 能够快速添加新的 PII 识别器。

---

## Acceptance Criteria

1. ✅ 实现 `BaseRecognizer` 抽象基类
2. ✅ 实现 `RecognizerRegistry` 注册表系统
3. ✅ 支持从 YAML 配置文件加载识别器
4. ✅ 实现基本的 `Entity` 数据模型
5. ✅ 单元测试覆盖率 > 80%

---

## Tasks / Subtasks

- [ ] **Task 1: 创建项目基础结构** (AC: 所有)
  - [ ] 创建 `src/hppe/engines/regex/` 目录结构
  - [ ] 创建 `__init__.py` 文件
  - [ ] 设置 Python 包配置

- [ ] **Task 2: 实现 Entity 数据模型** (AC: 4)
  - [ ] 创建 `src/hppe/models/entity.py`
  - [ ] 定义 `Entity` dataclass
  - [ ] 添加类型注解和文档字符串
  - [ ] 实现 `__str__` 和 `__repr__` 方法

- [ ] **Task 3: 实现 BaseRecognizer 抽象基类** (AC: 1)
  - [ ] 创建 `src/hppe/engines/regex/base.py`
  - [ ] 定义 `BaseRecognizer` ABC
  - [ ] 实现 `detect()` 抽象方法签名
  - [ ] 实现 `validate()` 抽象方法签名
  - [ ] 添加配置加载辅助方法
  - [ ] 实现上下文词检测逻辑
  - [ ] 实现拒绝列表过滤逻辑

- [ ] **Task 4: 实现 RecognizerRegistry 注册表** (AC: 2, 3)
  - [ ] 创建 `src/hppe/engines/regex/registry.py`
  - [ ] 实现识别器注册机制
  - [ ] 实现自动发现和加载
  - [ ] 实现 `detect()` 批量检测接口
  - [ ] 实现 `get_recognizers()` 查询接口
  - [ ] 添加线程安全保护

- [ ] **Task 5: 创建配置文件结构** (AC: 3)
  - [ ] 创建 `data/patterns/` 目录
  - [ ] 创建 `china_pii.yaml` 模板
  - [ ] 创建 `global_pii.yaml` 模板
  - [ ] 添加配置文件 JSON Schema

- [ ] **Task 6: 实现配置加载器** (AC: 3)
  - [ ] 创建 `src/hppe/engines/regex/config_loader.py`
  - [ ] 实现 YAML 文件解析
  - [ ] 实现配置验证逻辑
  - [ ] 添加错误处理

- [ ] **Task 7: 编写单元测试** (AC: 5)
  - [ ] 创建 `tests/unit/test_entity.py`
  - [ ] 创建 `tests/unit/test_base_recognizer.py`
  - [ ] 创建 `tests/unit/test_registry.py`
  - [ ] 创建 `tests/unit/test_config_loader.py`
  - [ ] 创建测试 fixture 和 mock 数据
  - [ ] 确保覆盖率 > 80%

- [ ] **Task 8: 编写文档和示例** (AC: 所有)
  - [ ] 添加模块级文档字符串
  - [ ] 创建使用示例
  - [ ] 更新 README（如果需要）

---

## Dev Notes

### 架构上下文

本故事是 HPPE 系统的基础组件，实现正则表达式引擎的核心框架。所有后续的 PII 识别器都将基于此框架构建。

**关键设计理念：**
- **模块化**：识别器相互独立，易于添加和维护
- **配置驱动**：通过 YAML 文件管理识别器，无需修改代码
- **可扩展性**：标准化的接口使得扩展变得简单
- **性能优先**：预编译正则表达式，避免重复编译开销

[Source: docs/architecture.md#4.1-正则引擎]

### 技术栈

**语言和框架：**
- Python 3.11+（类型注解是强制性的）
- pydantic（数据验证）
- PyYAML（配置解析）

[Source: docs/architecture/tech-stack.md#4-正则引擎框架]

### 数据模型规范

```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class Entity:
    """PII 实体数据模型"""
    entity_type: str         # PII 类型，如 "CHINA_ID_CARD"
    value: str               # 检测到的值
    start_pos: int           # 起始字符位置
    end_pos: int            # 结束字符位置
    confidence: float        # 置信度 [0.0, 1.0]
    detection_method: str    # 检测方法 "regex"
    recognizer_name: str     # 识别器名称
    metadata: Optional[dict] = None  # 额外元数据
```

[Source: docs/prd/epic-1-core-regex-engine.md#数据模型]

### 识别器基类规范

```python
from abc import ABC, abstractmethod
from typing import List
import re

class BaseRecognizer(ABC):
    """PII 识别器基类"""

    def __init__(self, config: dict):
        self.entity_type = config['entity_type']
        self.patterns = self._compile_patterns(config['patterns'])
        self.context_words = config.get('context_words', [])
        self.deny_lists = config.get('deny_lists', [])
        self.confidence_base = config.get('confidence_base', 0.85)

    @abstractmethod
    def detect(self, text: str) -> List[Entity]:
        """检测文本中的 PII 实体"""
        pass

    @abstractmethod
    def validate(self, entity: Entity) -> bool:
        """验证实体有效性（可选实现）"""
        pass

    def _compile_patterns(self, patterns: List[dict]) -> List[re.Pattern]:
        """预编译正则表达式"""
        return [re.compile(p['pattern']) for p in patterns]

    def _check_context(self, text: str, match_pos: int) -> float:
        """检查上下文词，返回置信度提升值"""
        # 实现上下文词检测逻辑
        pass
```

[Source: docs/architecture/source-tree.md#engines/regex]

### 配置文件格式

```yaml
# data/patterns/china_pii.yaml

recognizers:
  - name: ChinaIDCardRecognizer
    entity_type: CHINA_ID_CARD
    patterns:
      - pattern: '[1-9]\d{5}(19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[0-9Xx]'
        score: 0.9
    context_words:
      - '身份证'
      - '身份证号'
      - 'ID'
      - '证件号'
    deny_lists:
      - '订单号'
      - '流水号'
    validation:
      type: 'checksum'
      algorithm: 'china_id_card'
```

[Source: docs/prd/epic-1-core-regex-engine.md#配置文件格式]

### 注册表系统规范

```python
class RecognizerRegistry:
    """识别器注册表"""

    def __init__(self):
        self._recognizers = {}
        self._lock = threading.RLock()

    def register(self, recognizer: BaseRecognizer):
        """注册识别器"""
        with self._lock:
            self._recognizers[recognizer.entity_type] = recognizer

    def load_all(self, patterns_dir: str = "data/patterns"):
        """从配置文件加载所有识别器"""
        # 自动发现并加载 YAML 文件
        pass

    def detect(self, text: str) -> List[Entity]:
        """使用所有识别器检测 PII"""
        entities = []
        for recognizer in self._recognizers.values():
            entities.extend(recognizer.detect(text))
        return entities
```

[Source: docs/prd/epic-1-core-regex-engine.md#story-14]

### 文件位置

```
src/hppe/
├── models/
│   └── entity.py              # Entity 数据模型
├── engines/
│   └── regex/
│       ├── __init__.py
│       ├── base.py            # BaseRecognizer 基类
│       ├── registry.py        # RecognizerRegistry
│       ├── config_loader.py   # 配置加载器
│       └── recognizers/       # 识别器实现（后续故事）
│           └── __init__.py

data/
└── patterns/
    ├── china_pii.yaml         # 中文 PII 配置
    └── global_pii.yaml        # 全球 PII 配置

tests/
└── unit/
    ├── test_entity.py
    ├── test_base_recognizer.py
    ├── test_registry.py
    └── test_config_loader.py
```

[Source: docs/architecture/source-tree.md#项目目录结构]

### 性能要求

- **正则表达式预编译**：在初始化时预编译所有模式，避免运行时重复编译
- **避免灾难性回溯**：使用所有格量词（`*+`）和原子组（`(?>...)`）
- **线程安全**：注册表必须支持并发访问

[Source: docs/architecture.md#3.1-正则表达式引擎性能调优]

### 编码标准

1. **类型注解**：所有公共函数和方法必须包含类型注解
2. **文档字符串**：所有公共类和函数必须包含 docstring
3. **命名约定**：
   - 类名：驼峰命名（`BaseRecognizer`）
   - 函数名：小写下划线（`detect_pii`）
   - 常量：大写下划线（`MAX_TEXT_LENGTH`）
4. **导入顺序**：标准库 > 第三方库 > 本地模块

[Source: docs/architecture/coding-standards.md#1-python-编码规范]

### 错误处理

```python
from hppe.core.exceptions import (
    HPPEError,
    ValidationError,
    ConfigurationError
)

# 使用自定义异常
try:
    config = load_config(config_file)
except FileNotFoundError:
    raise ConfigurationError(f"Config file not found: {config_file}")
```

[Source: docs/architecture/coding-standards.md#3-异常处理]

---

## Testing

### 测试标准

**测试框架：** pytest
**覆盖率目标：** > 80%
**测试类型：** 单元测试

[Source: docs/architecture/coding-standards.md#6-测试规范]

### 测试文件位置

所有测试文件位于 `tests/unit/` 目录下，文件名以 `test_` 开头。

### 测试要求

1. **每个模块一个测试文件**
2. **使用 pytest fixtures** 管理测试数据
3. **测试正面和负面用例**
4. **测试边界条件**
5. **使用 mock 隔离外部依赖**

### 示例测试结构

```python
import pytest
from hppe.models.entity import Entity
from hppe.engines.regex.base import BaseRecognizer

class TestEntity:
    """Entity 数据模型测试"""

    def test_entity_creation(self):
        """测试实体创建"""
        entity = Entity(
            entity_type="TEST_TYPE",
            value="test_value",
            start_pos=0,
            end_pos=10,
            confidence=0.9,
            detection_method="regex",
            recognizer_name="TestRecognizer"
        )
        assert entity.entity_type == "TEST_TYPE"
        assert entity.confidence == 0.9

    def test_entity_str_representation(self):
        """测试字符串表示"""
        # ...
```

[Source: docs/architecture/coding-standards.md#61-单元测试]

### 运行测试

```bash
# 运行所有测试
pytest tests/unit/

# 运行特定测试文件
pytest tests/unit/test_entity.py

# 查看覆盖率
pytest --cov=src/hppe tests/unit/
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | Story 创建 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
待填写

### Debug Log References
待填写

### Completion Notes List
待填写

### File List
待填写

---

## QA Results
待填写