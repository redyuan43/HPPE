# 训练策略时间评估与对比

## 📊 当前数据情况

| 数据集 | 样本数 | PII类型 | 文件大小 |
|--------|--------|---------|---------|
| 原训练集（6种PII） | 56,215 | 6种 | 21 MB |
| 新生成数据（11种PII） | 13,000 | 11种 | 2.1 MB |
| **合并数据集（17种PII）** | **69,215** | **17种** | **23 MB** |

---

## ⏱️ 训练时间估算

### 基准参考（已完成的训练）

**历史数据**：
- 样本数：56,215
- 训练时间：18小时35分钟（2 epochs）
- 单epoch时间：~9小时18分钟
- 每1000步：~11-12分钟

**训练速度**：
- 每秒处理样本数：~0.84样本/秒
- 每分钟处理样本数：~50样本/分钟

---

## 🎯 方案对比

### 方案1：一次性训练17种PII ⭐⭐⭐⭐⭐

**训练配置**：
```
数据集: merged_17pii_train.jsonl
样本数: 69,215
PII类型: 17种
Epochs: 2
```

**时间估算**：
```
样本增长: 56,215 → 69,215 (+23%)
单epoch时间: 9.3小时 × 1.23 = ~11.4小时
总训练时间: 11.4小时 × 2 = 22.8小时

预计完成时间:
  - 今晚00:15启动 → 明晚23:00完成
  - 明早08:00启动 → 后天06:00完成
```

**优势**：
- ✅ 一步到位，17种PII全覆盖
- ✅ 所有PII类型在同一数据分布下训练，一致性最好
- ✅ 总GPU时间最短（~23小时）
- ✅ 最快商业化（2天内完成）

**劣势**：
- ⚠️ 一次投入时间较长（23小时）
- ⚠️ 如果出现问题，全盘返工

**成本**：
- GPU时间：~23小时
- 人工监控：1-2次中途检查

---

### 方案2：先训练11种新PII ⭐⭐⭐⭐

**第一阶段**：
```
数据集: generated_11pii_training.jsonl
样本数: 13,000
PII类型: 11种（新增）
Epochs: 2
```

**时间估算**：
```
单epoch时间: 13,000 / 56,215 × 9.3小时 = ~2.15小时
总训练时间: 2.15小时 × 2 = ~4.3小时

预计完成时间:
  - 今晚00:15启动 → 明早04:30完成 ✅
  - 明早08:00启动 → 中午12:15完成 ✅
```

**第二阶段**：
```
数据集: merged_17pii_train.jsonl
样本数: 69,215
PII类型: 17种（6种原有 + 11种新）
Epochs: 2
```

**时间估算**：
```
总训练时间: ~22.8小时
预计完成时间: 第一阶段完成后 + 23小时
```

**总时间**：
```
第一阶段: ~4.3小时
第二阶段: ~22.8小时
总计: ~27.1小时
```

**优势**：
- ✅ 快速验证11种新PII效果（4小时）
- ✅ 分阶段验证，风险可控
- ✅ 如果11种PII效果不好，可以调整数据再训练

**劣势**：
- ⚠️ 总GPU时间更长（27小时 vs 23小时，多4小时）
- ⚠️ 需要训练2次
- ⚠️ 第一阶段模型只能识别11种新PII，不能识别原有6种

**成本**：
- GPU时间：~27小时
- 人工监控：2次验证 + 2次中途检查

---

### 方案3：分3批训练 ⭐⭐⭐

**第一批**：高优先级PII（5种）
```
BANK_CARD, VEHICLE_PLATE, PASSPORT, DRIVER_LICENSE, SOCIAL_SECURITY_CARD
样本数: ~7,500
训练时间: ~2.5小时
```

**第二批**：中优先级PII（6种）
```
HK_MACAU_PASS, UNIFIED_SOCIAL_CREDIT_CODE, POSTAL_CODE,
IP_ADDRESS, IPV6_ADDRESS, MAC_ADDRESS
样本数: ~5,500
训练时间: ~1.8小时
```

**第三批**：全量训练17种
```
样本数: 69,215
训练时间: ~22.8小时
```

**总时间**：
```
第一批: ~2.5小时
第二批: ~1.8小时
第三批: ~22.8小时
总计: ~27.1小时
```

**优势**：
- ✅ 最大灵活性，每批都可以验证
- ✅ 风险最分散

**劣势**：
- ⚠️ 时间最长（27小时）
- ⚠️ 需要3次训练
- ⚠️ 过于繁琐，效率低

---

## 💡 推荐方案：方案2改良版 ⭐⭐⭐⭐⭐

### 策略：先快速训练11种新PII，验证后决定是否全量训练

**第一阶段（快速验证）**：
```
时间: 今晚00:15 → 明早04:30 (~4.3小时)
数据: 13,000样本（11种新PII）
目标: 验证数据质量 + 新PII学习效果
```

**验证点（明早05:00）**：
- [ ] 检查训练loss是否正常下降
- [ ] 用20-50样本快速验证11种新PII的Recall
- [ ] 如果效果好（Recall 60%+） → 继续第二阶段
- [ ] 如果效果差（Recall <40%） → 调整数据，重新生成

**第二阶段（全量训练）**：
```
时间: 明早08:00 → 后天07:00 (~23小时)
数据: 69,215样本（17种PII）
目标: 生产级模型
```

**总时间**：
```
最优情况: 4.3 + 23 = 27.3小时 (第一阶段有效)
最坏情况: 4.3 + 4.3 + 23 = 31.6小时 (第一阶段需重做)
```

---

## 📊 方案对比表

| 维度 | 方案1<br>(一次性17种) | 方案2<br>(先11种后17种) | 方案2改良版<br>(快速验证+全量) |
|------|---------------------|----------------------|---------------------------|
| **总GPU时间** | ⭐⭐⭐⭐⭐<br>23小时 | ⭐⭐⭐<br>27小时 | ⭐⭐⭐⭐<br>27.3小时 |
| **首次结果时间** | ⚠️<br>23小时后 | ⭐⭐⭐⭐⭐<br>4小时后 | ⭐⭐⭐⭐⭐<br>4小时后 |
| **风险控制** | ⭐⭐<br>一次全投 | ⭐⭐⭐⭐<br>分阶段验证 | ⭐⭐⭐⭐⭐<br>快速迭代 |
| **灵活性** | ⭐⭐<br>无法调整 | ⭐⭐⭐⭐<br>可调整 | ⭐⭐⭐⭐⭐<br>快速反馈 |
| **完成时间** | ⭐⭐⭐⭐⭐<br>2天 | ⭐⭐⭐<br>3天 | ⭐⭐⭐⭐<br>2.5天 |
| **适用场景** | 数据质量确定 | 保守稳健 | **平衡最优** |

---

## 🎯 关键洞察

### 为什么推荐"方案2改良版"？

**1. 快速反馈循环** ⭐⭐⭐⭐⭐
- 4小时就能看到11种新PII的效果
- 如果数据质量有问题，可以立即调整
- 避免23小时全量训练后发现问题

**2. 时间成本可控** ⭐⭐⭐⭐
- 只比方案1多4小时（27小时 vs 23小时）
- 但换来了验证机会和调整空间
- 如果第一阶段完美，总时间仅多18%

**3. 风险分散** ⭐⭐⭐⭐⭐
- 第一阶段验证数据生成脚本是否正确
- 第一阶段验证训练配置是否合理
- 第二阶段有更高的成功把握

**4. 灵活决策** ⭐⭐⭐⭐
- 如果第一阶段效果超预期（Recall 70%+） → 直接部署11种新PII
- 如果第一阶段效果不佳（Recall <50%） → 调整数据后重新生成
- 如果第一阶段效果中等（Recall 50-70%） → 继续全量训练

---

## 📋 第一阶段详细计划（推荐）

### 训练配置

**数据准备**：
```bash
# 使用现有的11种新PII数据
训练集: data/generated_11pii_training.jsonl (13,000样本)
验证集: 从测试集中抽取包含新PII的样本 (100-200样本)
```

**训练参数**：
```python
模型: Qwen3-4B
基础模型: /home/ivan/.cache/modelscope/hub/Qwen/Qwen3-4B
LoRA配置:
  - r: 16
  - alpha: 32
  - dropout: 0

训练配置:
  - epochs: 2
  - learning_rate: 2e-4
  - batch_size: 4
  - gradient_accumulation_steps: 4
  - warmup_steps: 5%
```

**时间线**：
```
00:15 - 启动训练
02:30 - Epoch 1完成（检查loss）
04:45 - Epoch 2完成
05:00 - 快速验证（20-50样本）
05:30 - 决策：继续/调整/停止
```

### 验证标准

**快速验证（50样本）**：

| Recall范围 | 评估 | 下一步 |
|-----------|------|--------|
| **≥70%** | ✅ 优秀 | 立即启动第二阶段全量训练 |
| **60-70%** | ✅ 良好 | 启动第二阶段，预期全量训练后达80%+ |
| **50-60%** | ⚠️ 中等 | 分析原因，小幅调整数据，再训练一次 |
| **<50%** | ❌ 不佳 | 重新审视数据生成策略 |

**关键检查点**：
1. BANK_CARD是否能与ID_CARD区分？
2. PASSPORT是否能与ID_CARD区分？
3. MAC_ADDRESS是否保持100%？（零样本时已达到）
4. IP_ADDRESS是否输出正确类型名？（零样本时输出IP）

---

## 💰 成本效益分析

### GPU时间成本

| 方案 | GPU总时长 | 电费成本(¥) | 时间成本 |
|------|----------|-----------|---------|
| 方案1 (一次性) | 23小时 | ~46元 | 2天 |
| 方案2改良版 | 27.3小时 | ~55元 | 2.5天 |
| 差异 | **+4.3小时** | **+9元** | **+0.5天** |

**结论**：多花9元 + 0.5天，换来快速验证和调整机会，**非常值得**！

---

## 🚀 立即行动计划

### 今晚执行（推荐 ⭐⭐⭐⭐⭐）

**00:15 - 00:30** - 准备训练脚本
- [ ] 修改训练脚本，使用13,000样本数据集
- [ ] 配置输出目录：`models/pii_qwen4b_11new/`
- [ ] 启动训练

**00:30 - 04:45** - 自动训练（无需人工干预）
- [ ] Epoch 1: 00:30 - 02:45
- [ ] Epoch 2: 02:45 - 04:45

**05:00 - 05:30** - 快速验证
- [ ] 运行50样本验证脚本
- [ ] 分析11种新PII的Recall
- [ ] 决定下一步

**05:30 - 08:00** - 决策时间
- **如果效果好（Recall ≥60%）**：
  - ✅ 修改训练脚本，使用69,215样本全量数据
  - ✅ 08:00启动第二阶段训练
  - ✅ 后天07:00完成

- **如果效果不好（Recall <50%）**：
  - ⚠️ 分析问题（数据质量？训练参数？）
  - ⚠️ 调整数据生成策略
  - ⚠️ 重新生成数据后再训练

---

## 📞 您的决策

请选择：

**A. 方案1 - 一次性训练17种PII** ⏰ 23小时
- 优势：最快，总GPU时间最短
- 劣势：无验证机会，风险集中
- 适合：对数据质量非常有信心

**B. 方案2改良版 - 先训练11种新PII（4小时），验证后全量训练** ⏰ 27小时
- 优势：快速反馈，风险可控，灵活调整
- 劣势：总GPU时间略长（+4小时）
- 适合：**稳健路线，强烈推荐** ⭐⭐⭐⭐⭐

**C. 明天白天再决定**
- 今晚先休息
- 明早仔细检查数据质量
- 白天启动训练

---

**当前时间**：00:10
**GPU状态**：空闲可用
**数据状态**：✅ 完全准备好

**我的建议**：选择 **B（方案2改良版）**
- 今晚00:15启动第一阶段（11种新PII）
- 明早05:00验证结果
- 如果效果好，明早08:00启动第二阶段（全量17种）
- 后天早上就能看到最终结果

**您的选择是？** 🚀
